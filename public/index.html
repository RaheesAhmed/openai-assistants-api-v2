<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenAI Assistant API Test UI</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #3498db;
        --secondary-color: #2c3e50;
        --background-color: #f8f9fa;
        --text-color: #333;
        --border-radius: 8px;
      }
      body {
        font-family: "Inter", sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
      }
      h1,
      h2 {
        color: var(--secondary-color);
      }
      .endpoints-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }
      .endpoint {
        background-color: #fff;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        transition: all 0.3s ease;
      }
      .endpoint:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
      input,
      textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #e0e0e0;
        border-radius: var(--border-radius);
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
      }
      button {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      button:hover {
        background-color: #2980b9;
      }
      .endpoint-response {
        white-space: pre-wrap;
        background-color: var(--secondary-color);
        color: #ecf0f1;
        padding: 15px;
        margin-top: 15px;
        border-radius: var(--border-radius);
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
      }
      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: none;
        margin: 10px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .endpoint-icon {
        margin-right: 10px;
        color: var(--primary-color);
      }
      .endpoint h2 {
        font-size: 18px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
      }
      .method-badge {
        font-size: 12px;
        padding: 3px 6px;
        border-radius: 4px;
        margin-left: auto;
        font-weight: bold;
      }
      .method-get {
        background-color: #61affe;
        color: #fff;
      }
      .method-post {
        background-color: #49cc90;
        color: #fff;
      }
      .method-patch {
        background-color: #fca130;
        color: #fff;
      }
      .method-delete {
        background-color: #f93e3e;
        color: #fff;
      }
      .group-container {
        margin-bottom: 40px;
      }
      .group-title {
        font-size: 24px;
        margin-bottom: 20px;
        color: var(--secondary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
      }
      .endpoints-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      .endpoint {
        flex: 1 1 calc(50% - 10px);
        min-width: 300px;
      }
      .settings-panel {
        background-color: #fff;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }
      .settings-panel h2 {
        margin-top: 0;
      }
      .settings-form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .settings-form input {
        flex: 1;
        min-width: 100px;
      }
      .settings-form button {
        flex: 0 0 auto;
      }
    </style>
  </head>
  <body>
    <h1>
      <i class="fas fa-robot endpoint-icon"></i>OpenAI Assistant API Test UI
    </h1>
    <div class="settings-panel">
      <h2>Settings</h2>
      <form id="rateLimitForm" class="settings-form">
        <input type="number" id="windowMs" placeholder="Window (ms)" required />
        <input
          type="number"
          id="maxRequests"
          placeholder="Max Requests"
          required
        />
        <button type="submit">Update Rate Limit</button>
      </form>
      <form id="fileSizeForm" class="settings-form">
        <input
          type="number"
          id="fileSize"
          placeholder="Max File Size (MB)"
          required
        />
        <button type="submit">Update File Size Limit</button>
      </form>
    </div>
    <div id="endpoint-groups"></div>

    <script>
      const baseUrl = "http://localhost:3000"; // Change this to your server's URL
      let defaults = {};

      // Fetch defaults from the server
      async function fetchDefaults() {
        try {
          const response = await axios.get(`${baseUrl}/api-defaults`);
          defaults = response.data;
          document.getElementById("windowMs").value =
            defaults.rateLimit.windowMs;
          document.getElementById("maxRequests").value = defaults.rateLimit.max;
          document.getElementById("fileSize").value = defaults.fileSize;
        } catch (error) {
          console.error("Error fetching defaults:", error);
        }
      }

      const endpointGroups = [
        {
          name: "Assistants",
          endpoints: [
            {
              name: "Create Assistant",
              method: "POST",
              url: "/create-assistant",
              hasBody: true,
            },
            {
              name: "List Assistants",
              method: "GET",
              url: "/list-assistants",
              hasQuery: true,
            },
            {
              name: "Retrieve Assistant",
              method: "GET",
              url: "/retrieve-assistant/:assistant_id",
              hasParams: true,
            },
            {
              name: "Update Assistant",
              method: "PATCH",
              url: "/update-assistant/:assistant_id",
              hasParams: true,
              hasBody: true,
            },
            {
              name: "Delete Assistant",
              method: "DELETE",
              url: "/delete-assistant/:assistant_id",
              hasParams: true,
            },
          ],
        },
        {
          name: "Threads",
          endpoints: [
            {
              name: "Create Thread",
              method: "POST",
              url: "/create-thread",
              hasBody: true,
            },
            {
              name: "Retrieve Thread",
              method: "GET",
              url: "/retrieve-thread/:thread_id",
              hasParams: true,
            },
            {
              name: "Update Thread",
              method: "PATCH",
              url: "/update-thread/:thread_id",
              hasParams: true,
              hasBody: true,
            },
            {
              name: "Delete Thread",
              method: "DELETE",
              url: "/delete-thread/:thread_id",
              hasParams: true,
            },
          ],
        },
        {
          name: "Messages",
          endpoints: [
            {
              name: "Create Message",
              method: "POST",
              url: "/create-message/:thread_id",
              hasParams: true,
              hasBody: true,
            },
            {
              name: "List Messages",
              method: "GET",
              url: "/list-messages/:thread_id",
              hasParams: true,
              hasQuery: true,
            },
            {
              name: "Retrieve Message",
              method: "GET",
              url: "/retrieve-message/:thread_id/:message_id",
              hasParams: true,
            },
            {
              name: "Update Message",
              method: "PATCH",
              url: "/update-message/:thread_id/:message_id",
              hasParams: true,
              hasBody: true,
            },
          ],
        },
        {
          name: "Runs",
          endpoints: [
            {
              name: "Create Run",
              method: "POST",
              url: "/create-run/:thread_id",
              hasParams: true,
              hasBody: true,
            },
            {
              name: "Retrieve Run",
              method: "GET",
              url: "/retrieve-run/:thread_id/:run_id",
              hasParams: true,
            },
            {
              name: "Cancel Run",
              method: "POST",
              url: "/cancel-run/:thread_id/:run_id",
              hasParams: true,
            },
            {
              name: "Submit Tool Outputs",
              method: "POST",
              url: "/submit-tool-outputs/:thread_id/:run_id",
              hasParams: true,
              hasBody: true,
            },
            {
              name: "List Run Steps",
              method: "GET",
              url: "/list-run-steps/:thread_id/:run_id",
              hasParams: true,
              hasQuery: true,
            },
            {
              name: "Retrieve Run Step",
              method: "GET",
              url: "/retrieve-run-step/:thread_id/:run_id/:step_id",
              hasParams: true,
            },
            {
              name: "Stream Run",
              method: "POST",
              url: "/stream-run/:thread_id/:run_id",
              hasParams: true,
              hasBody: true,
              isStream: true,
            },
          ],
        },
        {
          name: "Files",
          endpoints: [
            {
              name: "Upload File",
              method: "POST",
              url: "/upload-file",
              hasFile: true,
            },
            {
              name: "List Files",
              method: "GET",
              url: "/list-files",
              hasQuery: true,
            },
            {
              name: "Retrieve File",
              method: "GET",
              url: "/retrieve-file/:file_id",
              hasParams: true,
            },
            {
              name: "Delete File",
              method: "DELETE",
              url: "/delete-file/:file_id",
              hasParams: true,
            },
            {
              name: "Retrieve File Content",
              method: "GET",
              url: "/retrieve-file-content/:file_id",
              hasParams: true,
            },
          ],
        },
        {
          name: "Vector Stores",
          endpoints: [
            {
              name: "Create Vector Store",
              method: "POST",
              url: "/create-vector-store",
              hasBody: true,
            },
            {
              name: "List Vector Stores",
              method: "GET",
              url: "/list-vector-stores",
              hasQuery: true,
            },
            {
              name: "Retrieve Vector Store",
              method: "GET",
              url: "/retrieve-vector-store/:vector_store_id",
              hasParams: true,
            },
            {
              name: "Update Vector Store",
              method: "PATCH",
              url: "/update-vector-store/:vector_store_id",
              hasParams: true,
              hasBody: true,
            },
            {
              name: "Delete Vector Store",
              method: "DELETE",
              url: "/delete-vector-store/:vector_store_id",
              hasParams: true,
            },
          ],
        },
        {
          name: "Tools",
          endpoints: [
            {
              name: "Execute Tools",
              method: "POST",
              url: "/execute-tools/:thread_id/:run_id",
              hasParams: true,
              hasBody: true,
            },
          ],
        },
      ];

      function createEndpointUI(endpoint) {
        const div = document.createElement("div");
        div.className = "endpoint";
        div.innerHTML = `
          <h2>
            <i class="fas ${getEndpointIcon(endpoint)} endpoint-icon"></i>
            ${endpoint.name}
            <span class="method-badge method-${endpoint.method.toLowerCase()}">${
          endpoint.method
        }</span>
          </h2>
          <form>
            ${
              endpoint.hasParams
                ? '<input type="text" placeholder="Enter parameters (e.g., :thread_id/:run_id)" name="params">'
                : ""
            }
            ${
              endpoint.hasQuery
                ? '<input type="text" placeholder="Enter query string" name="query">'
                : ""
            }
            ${
              endpoint.hasBody
                ? '<textarea placeholder="Enter request body JSON" name="body"></textarea>'
                : ""
            }
            ${endpoint.hasFile ? '<input type="file" name="file">' : ""}
            <button type="submit"><i class="fas fa-paper-plane"></i> Send Request</button>
          </form>
          <div class="loader"></div>
          <div class="endpoint-response"></div>
        `;

        const form = div.querySelector("form");

        // Pre-fill form fields with defaults
        if (endpoint.hasParams) {
          const paramsInput = form.querySelector('input[name="params"]');
          paramsInput.value = getDefaultParams(endpoint);
        }
        if (endpoint.hasBody) {
          const bodyTextarea = form.querySelector('textarea[name="body"]');
          bodyTextarea.value = getDefaultBody(endpoint);
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const loader = div.querySelector(".loader");
          const responseDiv = div.querySelector(".endpoint-response");
          loader.style.display = "block";
          responseDiv.style.display = "none";
          const params = form.params ? form.params.value : "";
          const query = form.query ? form.query.value : "";
          const body = form.body ? form.body.value : "";
          const file = form.file ? form.file.files[0] : null;

          let url = baseUrl + endpoint.url;
          if (params) {
            const paramPairs = params.split("/");
            paramPairs.forEach((param, index) => {
              url = url.replace(/:[\w_]+/, param);
            });
          }
          if (query) url += `?${query}`;

          try {
            let response;
            if (endpoint.isStream) {
              const eventSource = new EventSource(url);
              eventSource.onmessage = (event) => {
                responseDiv.textContent += event.data + "\n";
                responseDiv.style.display = "block";
              };
              eventSource.onerror = () => {
                eventSource.close();
              };
              return;
            } else if (endpoint.hasFile) {
              const formData = new FormData();
              formData.append("file", file);
              response = await axios.post(url, formData, {
                headers: { "Content-Type": "multipart/form-data" },
              });
            } else {
              response = await axios({
                method: endpoint.method,
                url: url,
                data: body ? JSON.parse(body) : undefined,
              });
            }
            responseDiv.textContent = JSON.stringify(response.data, null, 2);
            responseDiv.style.display = "block";

            if (endpoint.name === "Create Assistant" && response.data.id) {
              defaults.assistantId = response.data.id;
              updateAssistantIdFields();
            }
          } catch (error) {
            responseDiv.textContent = `Error: ${error.message}`;
            responseDiv.style.display = "block";
          } finally {
            loader.style.display = "none";
          }
        });

        return div;
      }

      function updateAssistantIdFields() {
        const assistantFields = document.querySelectorAll(
          'input[name="params"]'
        );
        assistantFields.forEach((field) => {
          if (field.placeholder.includes(":assistant_id")) {
            field.value = defaults.assistantId;
          }
        });
      }

      function getEndpointIcon(endpoint) {
        switch (endpoint.method) {
          case "GET":
            return "fa-search";
          case "POST":
            return "fa-plus";
          case "PATCH":
            return "fa-edit";
          case "DELETE":
            return "fa-trash";
          default:
            return "fa-code";
        }
      }

      function getDefaultParams(endpoint) {
        const url = endpoint.url;
        return url
          .replace(/:assistant_id/g, defaults.assistantId)
          .replace(/:thread_id/g, defaults.threadId)
          .replace(/:message_id/g, defaults.messageId)
          .replace(/:run_id/g, defaults.runId)
          .replace(/:file_id/g, defaults.fileId)
          .replace(/:vector_store_id/g, defaults.vectorStoreId)
          .replace(/^\//, ""); // Remove leading slash
      }

      function getDefaultBody(endpoint) {
        switch (endpoint.name) {
          case "Create Assistant":
            return defaults.defaultBody.createAssistant;
          case "Create Thread":
            return defaults.defaultBody.createThread;
          case "Create Message":
            return defaults.defaultBody.createMessage;
          case "Create Run":
            return defaults.defaultBody.createRun;
          case "Create Vector Store":
            return defaults.defaultBody.createVectorStore;
          default:
            return "{}";
        }
      }

      function createGroupUI(group) {
        const groupContainer = document.createElement("div");
        groupContainer.className = "group-container";
        groupContainer.innerHTML = `
          <h2 class="group-title">${group.name}</h2>
          <div class="endpoints-row"></div>
        `;

        const endpointsRow = groupContainer.querySelector(".endpoints-row");
        group.endpoints.forEach((endpoint) => {
          endpointsRow.appendChild(createEndpointUI(endpoint));
        });

        return groupContainer;
      }

      async function initializeUI() {
        await fetchDefaults();
        const endpointGroupsContainer =
          document.getElementById("endpoint-groups");
        endpointGroups.forEach((group) => {
          endpointGroupsContainer.appendChild(createGroupUI(group));
        });
      }

      document
        .getElementById("rateLimitForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const windowMs = document.getElementById("windowMs").value;
          const max = document.getElementById("maxRequests").value;
          try {
            await axios.post(`${baseUrl}/update-rate-limit`, { windowMs, max });
            alert("Rate limit updated successfully");
          } catch (error) {
            alert("Error updating rate limit");
          }
        });

      document
        .getElementById("fileSizeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const fileSize = document.getElementById("fileSize").value;
          try {
            await axios.post(`${baseUrl}/update-file-size`, { fileSize });
            alert("File size limit updated successfully");
          } catch (error) {
            alert("Error updating file size limit");
          }
        });

      initializeUI();
    </script>
  </body>
</html>
