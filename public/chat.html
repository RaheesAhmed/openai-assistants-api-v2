<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced ChatGPT-like Interface</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      #chatbox {
        height: 400px;
        border: 1px solid #ccc;
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 10px;
      }
      #user-input {
        width: 70%;
        padding: 5px;
      }
      #send-button {
        padding: 5px 10px;
      }
      .message {
        margin-bottom: 10px;
      }
      .user-message {
        color: blue;
      }
      .assistant-message {
        color: green;
      }
      .error-message {
        color: red;
      }
      .status-message {
        color: gray;
        font-style: italic;
      }
      #file-list {
        margin-top: 20px;
      }
      #api-controls {
        margin-top: 20px;
        border-top: 1px solid #ccc;
        padding-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>OpenAI API TESTING</h1>
    <div id="chatbox"></div>
    <input
      type="text"
      id="user-input"
      placeholder="Type your message here..."
    />
    <button id="send-button">Send</button>

    <div id="file-upload">
      <h3>Upload File</h3>
      <input type="file" id="file-input" />
      <button id="upload-button">Upload</button>
    </div>

    <div id="file-list">
      <h3>Uploaded Files</h3>
      <ul id="files"></ul>
    </div>

    <div id="api-controls">
      <h3>API Controls</h3>
      <button id="create-assistant">Create Assistant</button>
      <button id="list-assistants">List Assistants</button>
      <button id="create-thread">Create Thread</button>
      <button id="list-messages">List Messages</button>
      <button id="create-run">Create Run</button>
      <button id="list-runs">List Runs</button>
      <button id="cancel-run">Cancel Run</button>
    </div>

    <script>
      let threadId = null;
      let currentRunId = null;
      const chatbox = document.getElementById("chatbox");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const fileInput = document.getElementById("file-input");
      const uploadButton = document.getElementById("upload-button");
      const fileList = document.getElementById("files");

      // Helper function to add messages to the chatbox
      function addMessage(role, content, className = "") {
        const messageElement = document.createElement("div");
        messageElement.className = `message ${className}`;
        messageElement.textContent = `${role}: ${content}`;
        chatbox.appendChild(messageElement);
        chatbox.scrollTop = chatbox.scrollHeight;
      }

      // Helper function to make API calls
      async function apiCall(endpoint, method = "GET", body = null) {
        try {
          const options = {
            method,
            headers: { "Content-Type": "application/json" },
          };
          if (body) options.body = JSON.stringify(body);
          const response = await fetch(endpoint, options);
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error(`Error calling ${endpoint}:`, error);
          addMessage("Error", error.message, "error-message");
        }
      }

      // Chat functions
      async function createThread() {
        const data = await apiCall("/create-thread", "POST");
        threadId = data.id;
        addMessage("System", `Thread created with ID: ${threadId}`);
      }

      async function sendMessage(message) {
        if (!threadId) await createThread();
        const data = await apiCall(`/create-message/${threadId}`, "POST", {
          role: "user",
          content: message,
        });
        addMessage("You", message, "user-message");
      }

      async function createRun() {
        const data = await apiCall(`/create-run/${threadId}`, "POST", {
          assistant_id: "asst_RGHCFcNICU126C8yeyKFcFi2", // Replace with your assistant ID
        });
        currentRunId = data.id;
        addMessage("System", `Run created with ID: ${currentRunId}`);
        return data;
      }

      async function streamRunResult(runId) {
        try {
          const response = await fetch(`/stream-run/${threadId}/${runId}`, {
            method: "POST",
          });
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split("\n\n");

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const eventData = line.slice(6).trim();
                if (eventData === "[DONE]") return;
                try {
                  const parsedData = JSON.parse(eventData);
                  if (parsedData.type === "message") {
                    addMessage(
                      "Assistant",
                      parsedData.content,
                      "assistant-message"
                    );
                  } else if (parsedData.type === "status") {
                    addMessage("Status", parsedData.content, "status-message");
                  } else if (parsedData.type === "error") {
                    throw new Error(parsedData.content);
                  }
                } catch (parseError) {
                  console.error("Error parsing event data:", parseError);
                }
              }
            }
          }
        } catch (error) {
          console.error("Error streaming run result:", error);
          addMessage("Error", error.message, "error-message");
        }
      }

      // File handling functions
      async function uploadFile() {
        const formData = new FormData();
        const fileInput = document.getElementById("file-input");
        formData.append("file", fileInput.files[0]);

        try {
          const response = await fetch("/upload-file", {
            method: "POST",
            body: formData,
          });
          const data = await response.json();
          addMessage("System", `File uploaded: ${data.filename}`);
          updateFileList();
        } catch (error) {
          console.error("Error uploading file:", error);
          addMessage("Error", error.message, "error-message");
        }
      }

      async function updateFileList() {
        const files = await apiCall("/list-files");
        fileList.innerHTML = "";
        files.data.forEach((file) => {
          const li = document.createElement("li");
          li.textContent = file.filename;
          const deleteButton = document.createElement("button");
          deleteButton.textContent = "Delete";
          deleteButton.onclick = () => deleteFile(file.id);
          li.appendChild(deleteButton);
          fileList.appendChild(li);
        });
      }

      async function deleteFile(fileId) {
        await apiCall(`/delete-file/${fileId}`, "DELETE");
        addMessage("System", `File deleted: ${fileId}`);
        updateFileList();
      }

      // Event listeners
      sendButton.addEventListener("click", async () => {
        const message = userInput.value.trim();
        if (message) {
          userInput.value = "";
          await sendMessage(message);
          const run = await createRun();
          await streamRunResult(run.id);
        }
      });

      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !sendButton.disabled) {
          sendButton.click();
        }
      });

      uploadButton.addEventListener("click", uploadFile);

      // API control buttons
      document
        .getElementById("create-assistant")
        .addEventListener("click", async () => {
          const data = await apiCall("/create-assistant", "POST", {
            name: "Test Assistant",
            instructions: "You are a helpful assistant.",
            model: "gpt-4-1106-preview",
          });
          addMessage("System", `Assistant created: ${data.id}`);
        });

      document
        .getElementById("list-assistants")
        .addEventListener("click", async () => {
          const data = await apiCall("/list-assistants");
          data.data.forEach((assistant) => {
            addMessage(
              "System",
              `Assistant: ${assistant.id} - ${assistant.name}`
            );
          });
        });

      document
        .getElementById("create-thread")
        .addEventListener("click", createThread);

      document
        .getElementById("list-messages")
        .addEventListener("click", async () => {
          if (!threadId) {
            addMessage(
              "Error",
              "No active thread. Create a thread first.",
              "error-message"
            );
            return;
          }
          const data = await apiCall(`/list-messages/${threadId}`);
          data.data.forEach((message) => {
            addMessage(message.role, message.content[0].text.value);
          });
        });

      document
        .getElementById("create-run")
        .addEventListener("click", createRun);

      document
        .getElementById("list-runs")
        .addEventListener("click", async () => {
          if (!threadId) {
            addMessage(
              "Error",
              "No active thread. Create a thread first.",
              "error-message"
            );
            return;
          }
          const data = await apiCall(`/list-runs/${threadId}`);
          data.data.forEach((run) => {
            addMessage("System", `Run: ${run.id} - Status: ${run.status}`);
          });
        });

      document
        .getElementById("cancel-run")
        .addEventListener("click", async () => {
          if (!currentRunId) {
            addMessage("Error", "No active run to cancel.", "error-message");
            return;
          }
          const data = await apiCall(
            `/cancel-run/${threadId}/${currentRunId}`,
            "POST"
          );
          addMessage(
            "System",
            `Run cancelled: ${data.id} - Status: ${data.status}`
          );
        });

      // Initialize
      updateFileList();
    </script>
  </body>
</html>
